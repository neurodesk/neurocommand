name: Update neurocontainers

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-neurocontainers.yml'
      - 'neurodesk/apps.json'
      - 'neurodesk/write_log.py'

# Prevent race conditions when multiple PRs are merged in quick succession.
# This ensures only one instance of this workflow runs at a time.
# If a second trigger occurs while the first is running, it will wait (queue).
concurrency:
  group: update-neurocontainers
  cancel-in-progress: false

jobs:
  upload_containers_simg:
    runs-on: self-hosted
    permissions:
      id-token: write
      contents: write
      pull-requests: write
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        token: ${{ secrets.ACCESS_TOKEN }}
        ref: main
        fetch-depth: 0
    - uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38
      with:
        python-version: 3.8
    - name: Configure AWS Credentials 1
      id: creds
      uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722
      with:
        aws-region: us-east-2
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        output-credentials: true
        role-duration-seconds: 28800 # 8 hours
    - name : Check if singularity container files exist in nectar cloud and build & upload if not there
      env:
        AWS_ACCESS_KEY_ID: ${{ env.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ env.AWS_SECRET_ACCESS_KEY }}
        AWS_SESSION_TOKEN: ${{ env.AWS_SESSION_TOKEN }}
      run: |
        rclone config create aws-neurocontainers-new s3 config_is_local false provider AWS env_auth true
        /bin/bash .github/workflows/upload_containers_simg.sh
    - name: Create or update applist pull request
      id: applist-pr
      env:
        GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        REPO: ${{ github.repository }}
      run: |
        set -euo pipefail

        BRANCH="bot/update-applist"
        BASE="main"

        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git fetch --no-tags origin "+refs/heads/${BASE}:refs/remotes/origin/${BASE}"
        git checkout -B "${BRANCH}" "refs/remotes/origin/${BASE}"

        git add cvmfs

        if git diff --cached --quiet; then
          echo "changes_detected=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        git commit -m "Update generated applist files"
        git push --force origin "HEAD:${BRANCH}"

        python3 - <<'PY'
        import json
        import os
        import urllib.parse
        import urllib.request

        repo = os.environ["REPO"]
        token = os.environ["GITHUB_TOKEN"]
        owner = repo.split("/", 1)[0]
        repo_name = repo.split("/", 1)[1]
        branch = "bot/update-applist"
        base = "main"

        headers = {
            "Accept": "application/vnd.github+json",
            "Authorization": f"Bearer {token}",
            "X-GitHub-Api-Version": "2022-11-28",
        }

        def api(method, path, payload=None, query=None):
            url = f"https://api.github.com/repos/{repo}{path}"
            if query:
                url = f"{url}?{urllib.parse.urlencode(query)}"
            data = None
            if payload is not None:
                data = json.dumps(payload).encode("utf-8")
            request = urllib.request.Request(url, method=method, data=data, headers=headers)
            with urllib.request.urlopen(request) as response:
                body = response.read().decode("utf-8")
                if not body:
                    return None
                return json.loads(body)

        def graphql(query, variables):
            data = json.dumps({"query": query, "variables": variables}).encode("utf-8")
            request = urllib.request.Request(
                "https://api.github.com/graphql",
                method="POST",
                data=data,
                headers={
                    "Accept": "application/vnd.github+json",
                    "Authorization": f"Bearer {token}",
                    "Content-Type": "application/json",
                    "X-GitHub-Api-Version": "2022-11-28",
                },
            )
            with urllib.request.urlopen(request) as response:
                body = response.read().decode("utf-8")
            parsed = json.loads(body) if body else {}
            errors = parsed.get("errors") or []
            if errors:
                raise RuntimeError("; ".join(err.get("message", "unknown graphql error") for err in errors))
            return parsed.get("data", {})

        existing = api(
            "GET",
            "/pulls",
            query={"state": "open", "head": f"{owner}:{branch}", "base": base, "per_page": 1},
        )

        payload = {
            "title": "Update generated applist.json",
            "body": (
                "Automated update generated by `update-neurocontainers.yml`.\n\n"
                "This PR contains regenerated files in `cvmfs/`, including `cvmfs/applist.json`."
            ),
        }

        if existing:
            api("PATCH", f"/pulls/{existing[0]['number']}", payload=payload)
            pr_number = int(existing[0]["number"])
        else:
            payload.update({"head": branch, "base": base, "maintainer_can_modify": True})
            created = api("POST", "/pulls", payload=payload)
            pr_number = int(created["number"])

        try:
            lookup = graphql(
                """
        query($owner: String!, $name: String!, $number: Int!) {
          repository(owner: $owner, name: $name) {
            pullRequest(number: $number) {
              id
              autoMergeRequest {
                enabledAt
              }
            }
          }
        }
        """,
                {"owner": owner, "name": repo_name, "number": pr_number},
            )
            pr_data = ((lookup.get("repository") or {}).get("pullRequest")) or {}
            pr_id = pr_data.get("id")
            if not pr_id:
                raise RuntimeError("could not resolve pull request node id")

            if pr_data.get("autoMergeRequest") is None:
                graphql(
                    """
        mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
          enablePullRequestAutoMerge(input: {
            pullRequestId: $pullRequestId
            mergeMethod: $mergeMethod
          }) {
            pullRequest {
              number
            }
          }
        }
        """,
                    {"pullRequestId": pr_id, "mergeMethod": "SQUASH"},
                )
                print(f"Enabled auto-merge (SQUASH) for PR #{pr_number}")
            else:
                print(f"Auto-merge already enabled for PR #{pr_number}")
        except Exception as exc:
            print(f"WARNING: Failed to enable auto-merge for PR #{pr_number}: {exc}")
        PY

        echo "changes_detected=true" >> "$GITHUB_OUTPUT"
